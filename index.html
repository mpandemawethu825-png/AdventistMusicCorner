<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JobMatch SA</title>

<!-- PDF & DOCX Parsers -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>

<style>
:root {
  --primary:#0f172a;
  --accent:#2563eb;
  --light:#f8fafc;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  margin:0;
  background:var(--light);
  color:#111;
}
header {
  background:var(--primary);
  color:white;
  padding:20px;
  text-align:center;
}
.container {
  max-width:900px;
  margin:auto;
  padding:20px;
}
.upload-box {
  border:2px dashed var(--accent);
  padding:30px;
  text-align:center;
  border-radius:12px;
  background:white;
}
input[type=file] {
  margin-top:15px;
}
button {
  background:var(--accent);
  color:white;
  border:none;
  padding:12px 20px;
  border-radius:8px;
  cursor:pointer;
  margin-top:15px;
}
button:disabled {
  background:gray;
}
.loading {
  margin-top:20px;
}
.job-card {
  background:white;
  padding:15px;
  margin-top:15px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
}
.match {
  font-weight:bold;
  color:green;
}
.error {
  color:red;
}
@media(max-width:600px){
  .job-card { font-size:14px; }
}
</style>
</head>
<body>

<header>
  <h1>JobMatch SA</h1>
  <p>Upload your CV and get matched with real South African jobs instantly.</p>
</header>

<div class="container">

<div class="upload-box">
  <h3>Upload CV (PDF or DOCX, max 5MB)</h3>
  <input type="file" id="cvFile" accept=".pdf,.docx">
  <br>
  <button onclick="processCV()">Find My Jobs</button>
  <div class="loading" id="loading"></div>
  <div class="error" id="error"></div>
</div>

<div id="results"></div>

</div>

<script>

const MAX_SIZE = 5 * 1024 * 1024;
const OPENAI_PROXY_ENDPOINT = "/api/analyze-cv"; 

async function processCV() {
  const fileInput = document.getElementById("cvFile");
  const file = fileInput.files[0];
  const errorDiv = document.getElementById("error");
  errorDiv.innerText = "";

  if (!file) return errorDiv.innerText = "Please upload a CV.";
  if (file.size > MAX_SIZE) return errorDiv.innerText = "File exceeds 5MB.";

  showLoading("Extracting text...");

  let text = "";
  if (file.type === "application/pdf") {
    text = await extractPDF(file);
  } else if (file.name.endsWith(".docx")) {
    text = await extractDOCX(file);
  } else {
    return errorDiv.innerText = "Unsupported file format.";
  }

  if (!text) return errorDiv.innerText = "Could not extract text.";

  showLoading("Analyzing CV with AI...");

  const structuredData = await analyzeCV(text);

  showLoading("Searching jobs...");

  const jobs = await fetchJobs(structuredData);

  showLoading("Matching jobs...");

  const rankedJobs = matchJobs(structuredData, jobs);

  displayJobs(rankedJobs);

  fileInput.value = "";
}

async function extractPDF(file) {
  const reader = new FileReader();
  return new Promise(resolve=>{
    reader.onload = async function() {
      const typedArray = new Uint8Array(this.result);
      const pdf = await pdfjsLib.getDocument(typedArray).promise;
      let text = "";
      for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(i=>i.str).join(" ");
      }
      resolve(text);
    };
    reader.readAsArrayBuffer(file);
  });
}

async function extractDOCX(file) {
  const arrayBuffer = await file.arrayBuffer();
  const result = await mammoth.extractRawText({arrayBuffer});
  return result.value;
}

async function analyzeCV(text) {
  const response = await fetch(OPENAI_PROXY_ENDPOINT,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({cvText:text})
  });
  return await response.json();
}

/* Sample public compliant source (Remotive demo as placeholder)
   Replace with SA compliant job APIs (e.g. RapidAPI Indeed, Adzuna SA API) */

async function fetchJobs(profile){
  const query = profile.industry + " " + profile.experience_level;
  const response = await fetch("https://remotive.com/api/remote-jobs?search="+encodeURIComponent(query));
  const data = await response.json();
  return data.jobs.slice(0,30).map(job=>({
    title:job.title,
    company:job.company_name,
    location:job.candidate_required_location,
    salary:job.salary || "Not specified",
    apply_link:job.url,
    source:"Remotive"
  }));
}

function matchJobs(profile,jobs){
  return jobs.map(job=>{
    let score = 0;

    const skillMatch = profile.skills.technical.filter(skill=>
      job.title.toLowerCase().includes(skill.toLowerCase())
    ).length;

    score += (skillMatch/profile.skills.technical.length)*40;

    if(job.location.includes(profile.location)) score+=20;
    if(profile.experience_level==="Senior") score+=30;
    if(profile.education_level) score+=10;

    return {...job,match:Math.round(score)};
  })
  .filter(job=>job.match>=70)
  .sort((a,b)=>b.match-a.match);
}

function displayJobs(jobs){
  hideLoading();
  const container = document.getElementById("results");
  container.innerHTML="";

  if(jobs.length===0){
    container.innerHTML="<p>No high-confidence matches found.</p>";
    return;
  }

  jobs.forEach(job=>{
    container.innerHTML += `
      <div class="job-card">
        <div class="match">${job.match}% Match</div>
        <h3>${job.title}</h3>
        <p><strong>${job.company}</strong></p>
        <p>${job.location}</p>
        <p>${job.salary}</p>
        <a href="${job.apply_link}" target="_blank">
          <button>Apply Now</button>
        </a>
        <p><small>Matched based on skills & experience alignment.</small></p>
      </div>
    `;
  });
}

function showLoading(text){
  document.getElementById("loading").innerText=text;
}

function hideLoading(){
  document.getElementById("loading").innerText="";
}

</script>
</body>
</html>
