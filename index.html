<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JobMatch SA</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<!-- Mammoth for DOCX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>

<style>
:root {
  --primary:#0f172a;
  --accent:#2563eb;
  --light:#f8fafc;
}
body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--light);
}
header {
  background:var(--primary);
  color:white;
  text-align:center;
  padding:20px;
}
.container {
  max-width:900px;
  margin:auto;
  padding:20px;
}
.upload-box {
  background:white;
  padding:30px;
  border-radius:12px;
  border:2px dashed var(--accent);
  text-align:center;
}
button {
  background:var(--accent);
  color:white;
  border:none;
  padding:12px 20px;
  border-radius:8px;
  cursor:pointer;
}
button:disabled {
  background:gray;
}
.loading { margin-top:15px; }
.error { color:red; }
.job-card {
  background:white;
  padding:15px;
  margin-top:15px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
}
.match {
  color:green;
  font-weight:bold;
}
@media(max-width:600px){
  .job-card{font-size:14px;}
}
</style>
</head>
<body>

<header>
  <h1>JobMatch SA</h1>
  <p>Upload your CV. Get matched instantly.</p>
</header>

<div class="container">

<div class="upload-box">
  <h3>Upload CV (PDF or DOCX, max 5MB)</h3>
  <input type="file" id="cvFile" accept=".pdf,.docx"><br><br>
  <button onclick="processCV()">Find Jobs</button>
  <div class="loading" id="loading"></div>
  <div class="error" id="error"></div>
</div>

<div id="results"></div>

</div>

<script>

const MAX_SIZE = 5 * 1024 * 1024;

async function processCV() {
  const file = document.getElementById("cvFile").files[0];
  const errorDiv = document.getElementById("error");
  errorDiv.innerText="";

  if(!file) return errorDiv.innerText="Please upload a CV.";
  if(file.size>MAX_SIZE) return errorDiv.innerText="File exceeds 5MB.";

  showLoading("Extracting CV text...");

  let text="";
  if(file.type==="application/pdf"){
    text = await extractPDF(file);
  } else if(file.name.endsWith(".docx")){
    text = await extractDOCX(file);
  } else {
    return errorDiv.innerText="Unsupported file format.";
  }

  showLoading("Analyzing CV...");

  const profile = analyzeText(text);

  showLoading("Fetching job listings...");

  const jobs = await fetchJobs(profile);

  showLoading("Matching jobs...");

  const ranked = matchJobs(profile,jobs);

  displayJobs(ranked);

  document.getElementById("cvFile").value="";
}

async function extractPDF(file){
  const reader = new FileReader();
  return new Promise(resolve=>{
    reader.onload=async function(){
      const typedArray=new Uint8Array(this.result);
      const pdf=await pdfjsLib.getDocument(typedArray).promise;
      let text="";
      for(let i=1;i<=pdf.numPages;i++){
        const page=await pdf.getPage(i);
        const content=await page.getTextContent();
        text+=content.items.map(i=>i.str).join(" ");
      }
      resolve(text);
    };
    reader.readAsArrayBuffer(file);
  });
}

async function extractDOCX(file){
  const buffer=await file.arrayBuffer();
  const result=await mammoth.extractRawText({arrayBuffer:buffer});
  return result.value;
}

/* RULE-BASED CV ANALYZER */

function analyzeText(text){
  const lower=text.toLowerCase();

  const techSkills=["javascript","python","excel","sql","react","node","marketing","sales","accounting","customer service"];
  const foundSkills=techSkills.filter(skill=>lower.includes(skill));

  const locationMatch=text.match(/(Cape Town|Johannesburg|Durban|Pretoria|Port Elizabeth)/i);
  const location=locationMatch?locationMatch[0]:"South Africa";

  let experienceLevel="Entry";
  if(lower.includes("5 years")||lower.includes("6 years")||lower.includes("7 years")) experienceLevel="Senior";
  else if(lower.includes("3 years")||lower.includes("4 years")) experienceLevel="Mid";
  else if(lower.includes("1 year")||lower.includes("2 years")) experienceLevel="Junior";

  return {
    skills:foundSkills,
    location,
    experienceLevel
  };
}

/* PUBLIC JOB SOURCE (Demo) */

async function fetchJobs(profile){
  const query=profile.skills.join(" ");
  const response=await fetch("https://remotive.com/api/remote-jobs?search="+encodeURIComponent(query));
  const data=await response.json();

  return data.jobs.slice(0,30).map(job=>({
    title:job.title,
    company:job.company_name,
    location:job.candidate_required_location,
    salary:job.salary||"Not specified",
    apply:job.url
  }));
}

/* WEIGHTED MATCHING */

function matchJobs(profile,jobs){
  return jobs.map(job=>{
    let score=0;

    const titleLower=job.title.toLowerCase();

    profile.skills.forEach(skill=>{
      if(titleLower.includes(skill)) score+=40/profile.skills.length;
    });

    if(job.location.includes(profile.location)) score+=20;

    if(profile.experienceLevel==="Senior") score+=30;
    if(profile.experienceLevel==="Mid") score+=20;
    if(profile.experienceLevel==="Junior") score+=10;

    return {...job,match:Math.round(score)};
  })
  .filter(job=>job.match>=70)
  .sort((a,b)=>b.match-a.match);
}

function displayJobs(jobs){
  hideLoading();
  const container=document.getElementById("results");
  container.innerHTML="";

  if(jobs.length===0){
    container.innerHTML="<p>No strong matches found. Try updating your CV keywords.</p>";
    return;
  }

  jobs.forEach(job=>{
    container.innerHTML+=`
      <div class="job-card">
        <div class="match">${job.match}% Match</div>
        <h3>${job.title}</h3>
        <p><strong>${job.company}</strong></p>
        <p>${job.location}</p>
        <p>${job.salary}</p>
        <a href="${job.apply}" target="_blank">
          <button>Apply Now</button>
        </a>
      </div>
    `;
  });
}

function showLoading(text){
  document.getElementById("loading").innerText=text;
}
function hideLoading(){
  document.getElementById("loading").innerText="";
}

</script>
</body>
</html>
